// ============================================
// Async Functions
// ============================================

async fn async_returns_int() -> int {
    return 42;
}

async fn async_add(int a, int b) -> int {
    return a + b;
}

async fn async_with_await() -> int {
    result := await async_returns_int();
    return result;
}

async fn async_void_fn() {
    x := 1;
}

async fn async_typed_await() -> int {
    int val = await async_returns_int();
    return val;
}

async fn async_multiple_awaits() -> int {
    a := await async_returns_int();
    b := await async_add(a, 10);
    return b;
}

async fn async_await_in_expr() -> int {
    result := await async_returns_int() + 10;
    return result;
}

async fn async_nested() -> int {
    result := await async_add(await async_returns_int(), 5);
    return result;
}

// ============================================
// Async Methods
// ============================================

Counter :: struct {
    value int
}

async Counter :: get_value_async(self) -> int {
    return self.value;
}

async Counter :: add_async(self, int amount) -> int {
    current := await self.get_value_async();
    return current + amount;
}

async Counter :: increment_async(self) {
    self.value = self.value + 1;
}

// ============================================
// Async Tests
// ============================================

async fn test_async_functions() {
    assert_eq(await async_returns_int(), 42);
    assert_eq(await async_add(2, 3), 5);
    assert_eq(await async_with_await(), 42);
    assert_eq(await async_typed_await(), 42);
    assert_eq(await async_multiple_awaits(), 52);
    assert_eq(await async_await_in_expr(), 52);
    assert_eq(await async_nested(), 47);
}

async fn test_async_methods() {
    c := Counter{ value: 41 };
    assert_eq(await c.get_value_async(), 41);
    assert_eq(await c.add_async(1), 42);
    await c.increment_async();
    assert_eq(c.value, 42);
}

// ============================================
// Channel Creation
// ============================================

async fn test_channel_create() {
    ch := Channel<int>();
}

async fn test_channel_types() {
    ch_int := Channel<int>();
    ch_str := Channel<str>();
    ch_bool := Channel<bool>();
}

// ============================================
// Channel Send/Recv
// ============================================

async fn test_send_recv() {
    ch := Channel<int>();
    await ch.send(42);
    val := await ch.recv();
    assert_eq(val, 42);
}

// ============================================
// Select Statement
// ============================================

async fn test_select_recv() {
    ch1 := Channel<int>();
    ch2 := Channel<int>();

    // Make the select deterministic and non-blocking by ensuring exactly one
    // channel has a value ready to receive.
    await ch1.send(41);

    chosen := 0;
    selected := 0;

    select {
        case val := ch1.recv() {
            chosen = 1;
            selected = val;
        }
        case val := ch2.recv() {
            chosen = 2;
            selected = val;
        }
    }

    assert_eq(chosen, 1);
    assert_eq(selected, 41);
}

// ============================================
// Sync test
// ============================================

fn test_sync_still_works() {
    x := 1;
    assert_eq(x, 1);
}
